# Frontend Migration Plan - Next.js API ‚Üí Rust Backend

**Objectif:** Migrer toutes les routes API Next.js vers le backend Rust Axum
**Statut:** üü° En cours
**Deadline:** 2025-10-21

---

## üìä √âtat des Routes API

### Inventaire Complet (52 fichiers API)

```bash
apps/dapp/pages/api/
‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îî‚îÄ‚îÄ [...nextauth].ts                    # ‚ö†Ô∏è √Ä MIGRER - Auth NextAuth
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ services.ts                         # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îú‚îÄ‚îÄ service-delivery.ts                 # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îî‚îÄ‚îÄ wallets.ts                          # üî¥ √Ä MIGRER
‚îú‚îÄ‚îÄ contracts/
‚îÇ   ‚îî‚îÄ‚îÄ tokens.ts                           # üü° LEGACY - Polygon (depreci√©)
‚îú‚îÄ‚îÄ experiences/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                            # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îî‚îÄ‚îÄ [id]/index.ts                       # ‚úÖ MIGR√â - Backend Rust
‚îú‚îÄ‚îÄ metrics/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                            # üî¥ √Ä MIGRER
‚îú‚îÄ‚îÄ service-categories/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                            # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îú‚îÄ‚îÄ [id]/index.ts                       # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îú‚îÄ‚îÄ [id]/detailed.ts                    # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îú‚îÄ‚îÄ as_consumer.ts                      # ‚úÖ MIGR√â - Backend Rust
‚îÇ   ‚îî‚îÄ‚îÄ as_provider.ts                      # ‚úÖ MIGR√â - Backend Rust
‚îú‚îÄ‚îÄ transactions/
‚îÇ   ‚îî‚îÄ‚îÄ [id]/status.ts                      # üü° LIGHTNING - √Ä adapter
‚îî‚îÄ‚îÄ users/
    ‚îî‚îÄ‚îÄ me/
        ‚îú‚îÄ‚îÄ about.ts                        # ‚úÖ MIGR√â - Backend Rust
        ‚îú‚îÄ‚îÄ cv.ts                           # ‚úÖ MIGR√â - Backend Rust
        ‚îú‚îÄ‚îÄ notifications.ts                # ‚úÖ MIGR√â - Backend Rust
        ‚îú‚îÄ‚îÄ pending.ts                      # ‚úÖ MIGR√â - Backend Rust
        ‚îú‚îÄ‚îÄ proposed-services.ts            # ‚úÖ MIGR√â - Backend Rust
        ‚îî‚îÄ‚îÄ wallet.ts                       # üî¥ √Ä MIGRER
```

**L√©gende:**
- ‚úÖ MIGR√â: Endpoint existe dans backend Rust
- üî¥ √Ä MIGRER: N√©cessite impl√©mentation backend
- üü° LEGACY/LIGHTNING: N√©cessite adaptation
- ‚ö†Ô∏è CRITIQUE: D√©pendance NextAuth

---

## üéØ Plan de Migration (4 Phases)

### Phase 1: Pr√©paration (Compl√©t√© ‚úÖ)

- [x] Cr√©er `apiClient.ts` - Service REST g√©n√©rique
- [x] Analyser toutes les routes API existantes
- [x] V√©rifier `vercel.json` - Proxification configur√©e
- [x] Documentation backend Rust compl√®te

**Fichiers cr√©√©s:**
- [apps/dapp/services/apiClient.ts](apps/dapp/services/apiClient.ts)
- [apps/dapp/services/daznoAPI.ts](apps/dapp/services/daznoAPI.ts) (d√©j√† existant)

---

### Phase 2: Migration Critique (En cours üü° - 1 semaine)

#### 2.1 NextAuth ‚Üí JWT Backend

**Probl√®me:** NextAuth g√®re l'auth avec sessions Next.js

**Solution:**
```typescript
// AVANT (NextAuth)
import { getSession } from 'next-auth/react';

const session = await getSession();

// APR√àS (Backend Rust JWT)
import { apiClient } from '@/services/apiClient';

const user = await apiClient.getCurrentUser();
```

**Fichiers √† modifier:**
- `apps/dapp/pages/api/auth/[...nextauth].ts` ‚Üí Supprimer
- `apps/dapp/utils/auth.ts` ‚Üí Remplacer par `apiClient.login()`
- Tous les `getSession()` ‚Üí `apiClient.getCurrentUser()`

**Backend endpoints n√©cessaires:**
- ‚úÖ `POST /api/auth/login` - Existe
- ‚úÖ `POST /api/auth/refresh` - Existe
- ‚ö†Ô∏è `POST /api/auth/t4g/callback` - √Ä impl√©menter
- ‚ö†Ô∏è `POST /api/auth/linkedin/callback` - √Ä impl√©menter

---

#### 2.2 User Wallet & Transactions

**Routes √† migrer:**
- `/api/users/me/wallet` ‚Üí `/api/users/me`
- `/api/admin/wallets` ‚Üí `/api/admin/users?include=wallet`
- `/api/transactions/[id]/status` ‚Üí `/api/lightning/payment/[hash]/status`

**Modifications backend n√©cessaires:**

```rust
// src/routes/users.rs
#[get("/users/me")]
async fn get_current_user_with_wallet(user: AuthUser) -> Result<Json<UserWithWallet>> {
    // Retourner user + balance Lightning
}

// src/routes/admin.rs
#[get("/admin/wallets")]
async fn get_all_wallets(admin: AdminUser) -> Result<Json<Vec<WalletInfo>>> {
    // Liste tous les wallets Lightning
}
```

---

#### 2.3 Metrics & Analytics

**Route √† migrer:**
- `/api/metrics/index` ‚Üí `/api/metrics`

**Backend endpoint:**
```rust
// src/routes/metrics.rs
#[get("/metrics")]
async fn get_metrics() -> Result<Json<MetricsResponse>> {
    Ok(Json(MetricsResponse {
        total_users: db.count_users().await?,
        total_proofs: db.count_proofs().await?,
        total_lightning_volume: lightning.get_total_volume().await?,
        active_mentoring_requests: db.count_active_requests().await?,
    }))
}
```

---

### Phase 3: Suppression Routes Next.js (3 jours)

Une fois tous les endpoints migr√©s:

```bash
# 1. Tester tous les flux critiques
npm run test:e2e

# 2. Supprimer progressivement les routes API
rm -rf apps/dapp/pages/api/admin
rm -rf apps/dapp/pages/api/experiences
rm -rf apps/dapp/pages/api/service-categories
rm -rf apps/dapp/pages/api/users

# 3. Garder temporairement:
# - apps/dapp/pages/api/auth/[...nextauth].ts (migration auth en dernier)
# - apps/dapp/pages/api/metrics/index.ts (dashboard admin)

# 4. Mettre √† jour vercel.json
# Retirer la section "functions" (plus de serverless Next.js)
```

**Checklist suppression:**
- [ ] Aucun `fetch('/api/...')` dans le code frontend
- [ ] Tests E2E passent √† 100%
- [ ] NextAuth remplac√© par JWT backend
- [ ] Dashboard admin fonctionnel
- [ ] Lightning payments working
- [ ] RGB proofs creation OK

---

### Phase 4: Nettoyage & Optimisation (2 jours)

```bash
# 1. Supprimer les d√©pendances Next.js inutiles
npm uninstall next-auth @next-auth/prisma-adapter

# 2. Retirer MongoDB du frontend
npm uninstall mongodb mongoose

# 3. Nettoyer libs/service/data
rm -rf libs/service/data/src/lib/dao
rm -rf libs/service/data/src/lib/models/Transaction.ts
rm -rf libs/service/data/src/lib/service-mongo.ts

# 4. Garder uniquement:
# - libs/service/data/src/lib/models/User.ts (types)
# - libs/service/data/src/lib/models/Service.ts (types)

# 5. Mettre √† jour package.json
```

---

## üîÑ Strat√©gie de Migration par Endpoint

### Template de migration

Pour chaque route API Next.js:

#### **√âtape 1: V√©rifier l'√©quivalent backend**

```bash
# Trouver l'endpoint correspondant
grep -r "GET /api/users" token4good-backend/src/routes/
```

#### **√âtape 2: Adapter le frontend**

```typescript
// AVANT - Next.js API Route
const response = await fetch('/api/users/me/wallet');
const wallet = await response.json();

// APR√àS - Backend Rust
import { apiClient } from '@/services/apiClient';
const user = await apiClient.getCurrentUser();
const wallet = user.lightning_balance;
```

#### **√âtape 3: Tester localement**

```bash
# Terminal 1: Backend Rust
cd token4good-backend && cargo run

# Terminal 2: Frontend Next.js
cd apps/dapp && npm run dev

# Terminal 3: Tests
curl http://localhost:3000/api/users/me \
  -H "Authorization: Bearer $TOKEN"
```

#### **√âtape 4: Supprimer l'ancienne route**

```bash
git rm apps/dapp/pages/api/users/me/wallet.ts
git commit -m "feat: migrate /api/users/me/wallet to Rust backend"
```

---

## üß™ Tests de Migration

### Tests Critiques √† Ex√©cuter

```typescript
// apps/dapp/__tests__/migration.test.ts

describe('API Migration Tests', () => {
  it('should authenticate with backend JWT', async () => {
    const response = await apiClient.login({
      email: 'test@example.com',
      password: 'test123',
    });
    expect(response.token).toBeDefined();
  });

  it('should fetch current user', async () => {
    const user = await apiClient.getCurrentUser();
    expect(user.id).toBeDefined();
    expect(user.email).toBeDefined();
  });

  it('should create mentoring request', async () => {
    const request = await apiClient.createMentoringRequest({
      title: 'Test Request',
      description: 'Test Description',
      mentee_id: 'user123',
    });
    expect(request.id).toBeDefined();
  });

  it('should create RGB proof', async () => {
    const proof = await apiClient.createProof({
      request_id: 'req123',
      mentor_id: 'mentor123',
      mentee_id: 'mentee123',
      rating: 5,
    });
    expect(proof.contract_id).toBeDefined();
  });

  it('should create Lightning invoice', async () => {
    const invoice = await apiClient.createLightningInvoice({
      amount_msat: 10000,
      description: 'Test payment',
    });
    expect(invoice.payment_request).toBeDefined();
  });
});
```

**Ex√©cuter les tests:**
```bash
npm run test apps/dapp/__tests__/migration.test.ts
```

---

## üìã Checklist de Migration Compl√®te

### Backend Rust
- [x] Endpoints users CRUD
- [x] Endpoints mentoring requests
- [x] Endpoints RGB proofs
- [x] Endpoints Lightning Network
- [ ] Endpoint metrics/analytics
- [ ] Endpoint wallets admin
- [ ] Callbacks OAuth (t4g, LinkedIn)

### Frontend Next.js
- [x] Service `apiClient.ts` cr√©√©
- [x] Service `daznoAPI.ts` mis √† jour
- [ ] Remplacer tous les `fetch('/api/...')`
- [ ] Tests E2E migration
- [ ] Supprimer routes API Next.js
- [ ] Supprimer d√©pendances MongoDB
- [ ] Mettre √† jour variables d'environnement

### Infrastructure
- [x] `vercel.json` proxification configur√©e
- [ ] Variables d'environnement Vercel
- [ ] Backend d√©ploy√© sur Railway
- [ ] Tests production

---

## üö® Risques & Mitigations

| Risque | Probabilit√© | Impact | Mitigation |
|--------|-------------|--------|------------|
| Session loss pendant migration | Moyen | √âlev√© | Feature flag, rollback rapide |
| Endpoints manquants backend | Faible | √âlev√© | Inventaire complet fait |
| Performance d√©grad√©e | Faible | Moyen | Backend Rust plus rapide que Node.js |
| Bugs authentification | Moyen | Critique | Tests E2E complets avant d√©ploiement |

---

## üìÖ Timeline D√©taill√©

```
Semaine 1 (2025-10-07 ‚Üí 2025-10-13):
  Lundi-Mardi: Impl√©menter endpoints manquants backend
  Mercredi-Jeudi: Migration NextAuth ‚Üí JWT
  Vendredi: Migration wallets & transactions

Semaine 2 (2025-10-14 ‚Üí 2025-10-20):
  Lundi-Mardi: Migration metrics & analytics
  Mercredi: Remplacer tous les fetch('/api/...')
  Jeudi-Vendredi: Tests E2E complets

Semaine 3 (2025-10-21 ‚Üí 2025-10-27):
  Lundi: Suppression routes API Next.js
  Mardi: Nettoyage d√©pendances
  Mercredi: Tests production
  Jeudi: D√©ploiement staging
  Vendredi: Validation finale

2025-10-28: üöÄ D√âPLOIEMENT PRODUCTION
```

---

## üîó Ressources

- [API Client Service](apps/dapp/services/apiClient.ts)
- [Dazno API Service](apps/dapp/services/daznoAPI.ts)
- [Backend API Documentation](token4good-backend/README.md)
- [Vercel Configuration](vercel.json)
- [Progress Report](PROGRESS_REPORT.md)

---

**Derni√®re mise √† jour:** 2025-09-30
**Responsable:** Claude Code
**Prochaine revue:** 2025-10-07